#!/bin/bash

# Stop execution on any error
set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== SIEM Installation (Rsyslog + Loki v3 + Promtail v3) ===${NC}"
echo "Configuration: MikroTik -> Rsyslog (File) -> Promtail -> Loki"
echo "Software Versions: Loki v3.3.2, Promtail v3.3.2"
echo ""

# --- 1. User Input ---
read -p "Enter the IP address of your MikroTik router: " MIKROTIK_IP

if [ -z "$MIKROTIK_IP" ]; then
    echo -e "${RED}Error: IP address cannot be empty.${NC}"
    exit 1
fi

# Using the latest stable v3 binaries
LOKI_VER="3.3.2"
PROMTAIL_VER="3.3.2"

# --- 2. System Preparation ---
echo -e "${BLUE}[1/7] Updating system packages...${NC}"
apt-get update -qq
apt-get install -y -qq rsyslog wget unzip curl

# --- 3. Rsyslog Configuration (Buffer) ---
echo -e "${BLUE}[2/7] Configuring Rsyslog...${NC}"

# Enable UDP 1514 in main config
sed -i '/module(load="imudp")/s/^#//g' /etc/rsyslog.conf
sed -i '/input(type="imudp" port="514")/s/^#//g' /etc/rsyslog.conf
# Change port from default 514 to 1514
sed -i 's/port="514"/port="1514"/g' /etc/rsyslog.conf
# Disable imklog to prevent "permission denied" errors in LXC containers
sed -i '/module(load="imklog")/s/^/#/g' /etc/rsyslog.conf

# Create a filter to isolate MikroTik logs into a separate file
cat > /etc/rsyslog.d/mikrotik.conf <<EOF
if \$fromhost-ip == '$MIKROTIK_IP' then {
    action(type="omfile" file="/var/log/mikrotik.log")
    stop
}
EOF

# Create the log file with correct permissions
touch /var/log/mikrotik.log
chmod 644 /var/log/mikrotik.log

# Configure Log Rotation (prevent disk filling)
cat > /etc/logrotate.d/mikrotik <<EOF
/var/log/mikrotik.log {
    daily
    rotate 7
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    postrotate
        /usr/lib/rsyslog/rsyslog-rotate
    endscript
}
EOF

# Restart Rsyslog to apply changes
systemctl restart rsyslog

# --- 4. Loki v3 Installation ---
echo -e "${BLUE}[3/7] Installing Loki v$LOKI_VER...${NC}"
cd /tmp
wget -q "https://github.com/grafana/loki/releases/download/v${LOKI_VER}/loki-linux-amd64.zip"
unzip -q -o loki-linux-amd64.zip
mv loki-linux-amd64 /usr/local/bin/loki
chmod +x /usr/local/bin/loki

# Create user and directories
if ! id "loki" &>/dev/null; then useradd --no-create-home --shell /bin/false loki; fi
mkdir -p /var/lib/loki
chown -R loki:loki /var/lib/loki
mkdir -p /etc/loki

# Loki Configuration (Adapted for v3: tsdb engine + schema v13)
cat > /etc/loki/config.yaml <<EOF
auth_enabled: false

server:
  http_listen_port: 3100
  grpc_listen_port: 9096

common:
  path_prefix: /var/lib/loki
  storage:
    filesystem:
      chunks_directory: /var/lib/loki/chunks
      rules_directory: /var/lib/loki/rules
  replication_factor: 1
  ring:
    instance_addr: 127.0.0.1
    kvstore:
      store: inmemory

schema_config:
  configs:
    - from: 2024-01-01
      store: tsdb
      object_store: filesystem
      schema: v13
      index:
        prefix: index_
        period: 24h

compactor:
  working_directory: /var/lib/loki/compactor
  delete_request_store: filesystem

analytics:
  reporting_enabled: false
EOF

# Systemd unit for Loki
cat > /etc/systemd/system/loki.service <<EOF
[Unit]
Description=Loki service
After=network.target

[Service]
Type=simple
User=loki
ExecStart=/usr/local/bin/loki -config.file /etc/loki/config.yaml
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# --- 5. GeoIP Database ---
echo -e "${BLUE}[4/7] Downloading GeoIP Database (P3TERX source)...${NC}"
mkdir -p /etc/promtail
wget -q -O /etc/promtail/GeoLite2-City.mmdb "https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb"

# --- 6. Promtail v3 Installation ---
echo -e "${BLUE}[5/7] Installing Promtail v$PROMTAIL_VER...${NC}"
cd /tmp
wget -q "https://github.com/grafana/loki/releases/download/v${PROMTAIL_VER}/promtail-linux-amd64.zip"
unzip -q -o promtail-linux-amd64.zip
mv promtail-linux-amd64 /usr/local/bin/promtail
chmod +x /usr/local/bin/promtail

mkdir -p /var/lib/promtail

# Promtail Configuration (Reads Rsyslog file + applies GeoIP)
cat > /etc/promtail/config.yaml <<EOF
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /var/lib/promtail/positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push

scrape_configs:
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: "mikrotik_via_rsyslog"
          __path__: /var/log/mikrotik.log

    pipeline_stages:
      # Regex for Firewall log format (IP:PORT->)
      - regex:
          expression: ',\s(?P<source_ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}):\d+->'

      # Regex for Standard log format (src-address=)
      - regex:
          expression: 'src-address=(?P<source_ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})'

      # GeoIP lookup
      - geoip:
          db: "/etc/promtail/GeoLite2-City.mmdb"
          source: "source_ip"
          db_type: "city"

      # Pack metadata into JSON for Grafana
      - pack:
          labels:
            - source_ip
            - geoip_country_name
            - geoip_city_name
            - geoip_location_latitude
            - geoip_location_longitude
EOF

# Systemd unit for Promtail
cat > /etc/systemd/system/promtail.service <<EOF
[Unit]
Description=Promtail service
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/promtail -config.file /etc/promtail/config.yaml
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# --- 7. Finalization ---
echo -e "${BLUE}[6/7] Starting services...${NC}"
systemctl daemon-reload
systemctl enable loki promtail
systemctl restart loki promtail

# Cleanup temporary files
rm -f /tmp/loki-linux-amd64.zip /tmp/promtail-linux-amd64.zip /tmp/loki-linux-amd64 /tmp/promtail-linux-amd64

# Get the server's IP
MY_IP=$(hostname -I | awk '{print $1}')

echo -e "${GREEN}=== INSTALLATION COMPLETE! ===${NC}"
echo "-----------------------------------------------------------"
echo "Configure your MikroTik Router (Run in Terminal):"
echo ""
echo "1. Create Logging Action:"
echo "   /system logging action add name=lokisyslog target=remote remote=$MY_IP remote-port=1514 src-address=0.0.0.0 remote-log-format=bsd-syslog syslog-time-format=bsd-syslog syslog-facility=local0"
echo "   (Note: If you are on RouterOS v7 and it fails, try 'remote-log-format=default')"
echo ""
echo "2. Enable Logging Rules:"
echo "   /system logging add topics=info action=lokisyslog"
echo "   /system logging add topics=error action=lokisyslog"
echo "   /system logging add topics=firewall action=lokisyslog"
echo ""
echo "3. Enable Logging on Firewall Drop Rule (Crucial for Attack Map):"
echo "   /ip firewall filter set [find action=drop chain=input] log=yes
echo "-----------------------------------------------------------"
